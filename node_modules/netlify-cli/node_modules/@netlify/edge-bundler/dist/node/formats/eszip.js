import { join } from 'path';
import { wrapBundleError } from '../bundle_error.js';
import { getPackagePath } from '../package_json.js';
import { getFileHash } from '../utils/sha256.js';
const bundleESZIP = async ({ basePath, buildID, debug, deno, distDirectory, functions, importMap, }) => {
    const extension = '.eszip';
    const destPath = join(distDirectory, `${buildID}${extension}`);
    const bundler = getESZIPBundler();
    const payload = {
        basePath,
        destPath,
        functions,
        importMapURL: importMap.toDataURL(),
    };
    const flags = ['--allow-all', '--no-config'];
    if (!debug) {
        flags.push('--quiet');
    }
    try {
        await deno.run(['run', ...flags, bundler, JSON.stringify(payload)], { pipeOutput: true });
    }
    catch (error) {
        throw wrapBundleError(error, { format: 'eszip' });
    }
    const hash = await getFileHash(destPath);
    return { extension, format: 'eszip2', hash };
};
const getESZIPBundler = () => {
    const packagePath = getPackagePath();
    const bundlerPath = join(packagePath, 'deno', 'bundle.ts');
    return bundlerPath;
};
export { bundleESZIP as bundle };
